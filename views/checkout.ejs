<!-- <body> -->
<%- include('hero.ejs') %>
<section class="checkout spad">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h6>
          <span class="icon_tag_alt"></span> Have a coupon?
          <a href="#">Click here</a> to enter your code
        </h6>
      </div>
    </div>
    <div class="checkout__form">
      <h4>Billing Details</h4>
      <form method="POST">
        <div class="row">
          <% console.log(userSessionExists); %> <% if (!userSessionExists) { %>
          <%- include('billingform.ejs') %> <% } %> <% if (userSessionExists) {
          %> <%- include('billingoptions.ejs') %> <% } %>
          <div class="col-lg-4 col-md-6">
            <div class="checkout__order">
              <h4>Your Order</h4>
              <div class="checkout__order__products">
                Products <span>Total</span>
              </div>
              <ul id="cartItemList">
                <!-- Cart items will be dynamically added here -->
              </ul>
              <div class="checkout__order__total">
                Total <span>KES 00.00</span>
              </div>
              Kindly pay via mpesa till then paste the mpesa confirmation code
              below
              <hr />
              Till : <strong>9698167</strong>
              <BR />
              Name : <strong>LIME BOW GIFTS</strong>
              <hr />
              <div class="checkout__input__checkbox">
                <label for="payment1">
                  Mpesa
                  <input
                    type="text"
                    id="payment1"
                    value="mpesa"
                    name="payment_method"
                  />
                  <span class="checkmark"></span>
                </label>
                <div class="checkout__input">
                  <p>Mpesa Confirmation<span>*</span></p>
                  <input
                    type="text"
                    name="mpesa_confirmation"
                    placeholder="XXXXXXXXXX"
                    required
                  />
                  <p>Mpesa Confirmation<span>*</span></p>
                  <input
                    type="text"
                    name="mpesa_confirmation"
                    placeholder="XXXXXXXXXX"
                    required
                  />
                </div>
              </div>
              <button type="submit" class="site-btn">PLACE ORDER</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div
    class="toast"
    id="successToast"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
    data-autohide="true"
    data-delay="3000"
  >
    <div class="toast-header">
      <strong class="mr-auto">Success</strong>
      <button
        type="button"
        class="ml-2 mb-1 close"
        data-dismiss="toast"
        aria-label="Close"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body">
      <!-- Toast message will be displayed here -->
    </div>
  </div>
</section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $("form").submit(function (event) {
      event.preventDefault(); // Prevent the default form submission

      // Serialize the form data
      var formData = {};
      $(this)
        .find("input, select")
        .each(function () {
          formData[$(this).attr("name")] = $(this).val();
        });

      const storedCartItems =
        JSON.parse(localStorage.getItem("cartItems")) || [];
      const paymentData = {
        cartItems: storedCartItems, // Assuming storedCartItems contains the cart items
        total: totalPrice.toFixed(2), // Format total as a string with two decimal places
      };

      // Merge the form data and payment data into one object
      const requestData = {
        ...formData,
        ...paymentData,
      };

      $.ajax({
        type: "POST",
        url: "/api/payments/confirmation",
        contentType: "application/json", // Set the content type to JSON
        data: JSON.stringify(requestData),
        success: function (response) {
          // Handle the success response here
          //console.log("Success:", response);
          const userId = response.user;
          console.log(userId);

          // Display the toast message
          var toastMessage = response.success; // Replace with the actual success message
          var successToast = document.getElementById("successToast");
          var toastBody = successToast.querySelector(".toast-body");
          toastBody.textContent = toastMessage;
          var toast = new bootstrap.Toast(successToast);
          toast.show();
          alert(response.success);
          localStorage.removeItem("cartItems");
          window.location.href = `/success/${userId}`;

          // You can optionally redirect the user or perform other actions after clearing the cartItems
        },
        error: function (error) {
          // Handle the error response here
          console.error("Error:", error);
          // You can display an error message to the user if needed
        },
      });
    });
  });
  const storedCartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
  const cartItemList = document.getElementById("cartItemList");
  let totalPrice = 0;
  storedCartItems.forEach((item) => {
    const liElement = document.createElement("li");
    const itemTotalPrice = (item.price * item.quantity).toFixed(2);
    totalPrice += item.price * item.quantity;
    liElement.innerHTML = `${item.product_name} <span>KES ${itemTotalPrice}</span>`;
    cartItemList.appendChild(liElement);
  });
  const totalElement = document.querySelector(".checkout__order__total span");
  totalElement.textContent = `KES ${totalPrice.toFixed(2)}`;

  // Get references to the checkboxes
  const payment1Checkbox = document.getElementById("payment1");
  const payment2Checkbox = document.getElementById("payment2");

  // Add an event listener to each checkbox
  payment1Checkbox.addEventListener("change", function () {
    if (payment1Checkbox.checked) {
      // If the first checkbox is checked, uncheck the second one
      payment2Checkbox.checked = false;
    }
  });

  payment2Checkbox.addEventListener("change", function () {
    if (payment2Checkbox.checked) {
      // If the second checkbox is checked, uncheck the first one
      payment1Checkbox.checked = false;
    }
  });
</script>

<!-- </body> -->
